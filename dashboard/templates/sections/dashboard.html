<!-- Dashboard View (Overview) -->
                <div class="page-view" :class="{ active: activeNavItem === 'dashboard' }">
                <div class="content">
                    <!-- Bot Stopped Placeholder -->
                    <div v-if="!status.bot_running" class="bot-stopped-placeholder">
                        <div class="bot-stopped-icon" :class="{ 'is-loading': loading.start }">
                            <svg v-if="!loading.start" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2v4"/>
                                <path d="m16.2 7.8 2.9-2.9"/>
                                <path d="M18 12h4"/>
                                <path d="m16.2 16.2 2.9 2.9"/>
                                <path d="M12 18v4"/>
                                <path d="m4.9 19.1 2.9-2.9"/>
                                <path d="M2 12h4"/>
                                <path d="m4.9 4.9 2.9 2.9"/>
                            </svg>
                            <svg v-else class="loading-spinner-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                            </svg>
                        </div>
                        <div class="bot-stopped-title">[[ loading.start ? 'Starting Bot...' : 'Trading Bot Inactive' ]]</div>
                        <div class="bot-stopped-subtitle">
                            <template v-if="loading.start">
                                <div class="loading-steps">
                                    <div class="loading-step" :class="{ active: startingStep >= 1, done: startingStep > 1 }">
                                        <span class="step-icon">[[ startingStep > 1 ? '✓' : '1' ]]</span>
                                        <span>Initializing connections...</span>
                                    </div>
                                    <div class="loading-step" :class="{ active: startingStep >= 2, done: startingStep > 2 }">
                                        <span class="step-icon">[[ startingStep > 2 ? '✓' : '2' ]]</span>
                                        <span>Connecting to Telegram...</span>
                                    </div>
                                    <div class="loading-step" :class="{ active: startingStep >= 3, done: startingStep > 3 }">
                                        <span class="step-icon">[[ startingStep > 3 ? '✓' : '3' ]]</span>
                                        <span>Connecting to MT5 broker...</span>
                                    </div>
                                    <div class="loading-step" :class="{ active: startingStep >= 4 }">
                                        <span class="step-icon">4</span>
                                        <span>Starting signal listener...</span>
                                    </div>
                                </div>
                            </template>
                            <template v-else>
                                <span v-if="!account.login">Connect your MT5 account to start trading.</span>
                                <span v-else>Start the bot to begin monitoring Telegram signals and executing trades automatically on your MT5 account.</span>
                            </template>
                        </div>
                        <div class="bot-stopped-actions" v-if="!loading.start">
                            <!-- Show MT5 Login button if not connected -->
                            <button v-if="!account.login" class="btn-start" @click="showMT5LoginModal = true" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border);">
                                <img src="/assets/logos/mt5.webp" alt="MT5" style="width: 18px; height: 18px; margin-right: 8px; border-radius: 3px;" />
                                Connect MT5
                            </button>
                            <!-- Show Start Bot button if MT5 is connected -->
                            <button v-else class="btn-start" @click="startBot" :disabled="loading.bot || (!status.telegram_connected && !telegramSessionValid)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6 3 20 12 6 21 6 3"/></svg>
                                Start Bot
                            </button>
                            <div class="bot-stopped-status" :class="{ ready: account.login && (telegramSessionValid || status.telegram_connected) }">
                                <span class="status-dot"></span>
                                <span v-if="!account.login">MT5 account required</span>
                                <span v-else-if="(telegramSessionValid || status.telegram_connected)">Ready to start</span>
                                <span v-else>Configure Telegram first</span>
                            </div>
                        </div>
                        <div class="bot-stopped-features">
                            <div class="bot-stopped-feature">
                                <div class="bot-stopped-feature-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.1 19.1 19"/></svg>
                                </div>
                                <span>Signal Capture</span>
                            </div>
                            <div class="bot-stopped-feature">
                                <div class="bot-stopped-feature-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                                </div>
                                <span>Auto Trading</span>
                            </div>
                            <div class="bot-stopped-feature">
                                <div class="bot-stopped-feature-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>
                                </div>
                                <span>Risk Control</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Row (only show when bot is running) -->
                    <div v-else>
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-label">Balance</div>
                            <div class="stat-value animated-number" :data-value="account.balance">[[ currencySymbol ]][[ formatNumber(account.balance) ]]</div>
                            <div class="stat-sub">[[ account.currency || 'USD' ]]</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Equity</div>
                            <div class="stat-value animated-number" :data-value="account.equity">[[ currencySymbol ]][[ formatNumber(account.equity) ]]</div>
                            <div class="stat-sub">Free: <span class="animated-number" :data-value="account.free_margin">[[ currencySymbol ]][[ formatNumber(account.free_margin) ]]</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Floating P/L</div>
                            <div class="stat-value animated-number" :class="account.profit >= 0 ? 'positive' : 'negative'" :data-value="account.profit">
                                [[ account.profit >= 0 ? '+' : '' ]][[ currencySymbol ]][[ formatNumber(account.profit) ]]
                            </div>
                            <div class="stat-sub">Unrealized</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value animated-number" :data-value="stats.win_rate">[[ stats.closed_trades > 0 ? (stats.win_rate || 0).toFixed(1) : '—' ]]%</div>
                            <div class="stat-sub">[[ stats.winning_trades || 0 ]]/[[ stats.closed_trades || 0 ]] closed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Open Positions</div>
                            <div class="stat-value animated-number" :data-value="mt5Positions.length">[[ mt5Positions.length ]]</div>
                            <div class="stat-sub">MT5 Account</div>
                        </div>
                    </div>
                    
                    <!-- Trades Table -->
                    <div class="trades-section">
                        <div class="section-header">
                            <div class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                                <span>Open Positions</span>
                                <span class="badge">[[ mt5Positions.length ]]</span>
                            </div>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <!-- View Toggle -->
                                <div class="view-toggle" v-if="mt5Positions.length > 0">
                                    <button class="view-toggle-btn" :class="{ active: groupPositionsView }" @click="setPositionsView(true)" title="Group by Signal">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
                                    </button>
                                    <button class="view-toggle-btn" :class="{ active: !groupPositionsView }" @click="setPositionsView(false)" title="List View">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
                                    </button>
                                </div>
                                <button class="btn" @click="refreshPositions" :disabled="loading.positions" style="padding: 4px 10px; font-size: 11px;">
                                    <span v-if="loading.positions" class="spinner spinner-dark" style="width: 10px; height: 10px;"></span>
                                    <svg v-else xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                                </button>
                                <button class="btn btn-secondary" @click="navigateTo('trades')" style="padding: 4px 10px; font-size: 11px;">
                                    View All
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- List View (Flat Table) -->
                        <div class="table-wrapper" v-if="mt5Positions.length > 0 && !groupPositionsView">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ticket</th>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Volume</th>
                                        <th>Entry</th>
                                        <th>Current</th>
                                        <th>SL</th>
                                        <th>TP</th>
                                        <th>P/L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="pos in mt5Positions" :key="pos.position_ticket">
                                        <td class="font-mono">[[ pos.position_ticket ]]</td>
                                        <td class="symbol-cell">[[ pos.symbol ]]</td>
                                        <td :class="pos.direction === 'BUY' ? 'direction-buy' : 'direction-sell'">
                                            [[ pos.direction ]]
                                        </td>
                                        <td>[[ pos.lot_size ]]</td>
                                        <td class="font-mono">[[ formatPrice(pos.entry_price, pos.symbol) ]]</td>
                                        <td class="font-mono">[[ formatPrice(pos.current_price, pos.symbol) ]]</td>
                                        <td class="font-mono">[[ pos.stop_loss ? formatPrice(pos.stop_loss, pos.symbol) : '-' ]]</td>
                                        <td class="font-mono">[[ pos.take_profit_1 ? formatPrice(pos.take_profit_1, pos.symbol) : '-' ]]</td>
                                        <td :class="pos.profit >= 0 ? 'profit-positive' : 'profit-negative'" style="font-weight: 600;">
                                            [[ pos.profit >= 0 ? '+' : '' ]]$[[ pos.profit.toFixed(2) ]]
                                        </td>
                                        <td>
                                            <div class="trade-actions">
                                                <button class="btn-action btn-modify" @click="openModifyModal(pos)" title="Modify SL/TP">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                                </button>
                                                <button class="btn-action btn-close-trade" 
                                                        @click="closePosition(pos.position_ticket)" 
                                                        :disabled="loading.trades[pos.position_ticket]"
                                                        title="Close Position">
                                                    <span v-if="loading.trades[pos.position_ticket]" class="spinner" style="width: 10px; height: 10px;"></span>
                                                    <svg v-else xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr style="background: var(--bg-secondary); font-weight: 600;">
                                        <td colspan="8" style="text-align: right;">Total P/L:</td>
                                        <td :class="totalPnL >= 0 ? 'profit-positive' : 'profit-negative'">
                                            [[ totalPnL >= 0 ? '+' : '' ]]$[[ totalPnL.toFixed(2) ]]
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Grouped View (Signal Cards) -->
                        <div v-if="mt5Positions.length > 0 && groupPositionsView">
                            <div v-for="(group, signalId) in groupedPositions" :key="signalId" class="signal-group" :class="{ collapsed: group.collapsed }">
                                <div class="signal-group-header" @click="group.collapsed = !group.collapsed">
                                    <div class="signal-group-expand">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                                    </div>
                                    <div class="signal-channel-avatar">
                                        <img v-if="group.channel && (group.channel.photo || group.channel.has_photo)" :src="'/api/telegram/channel/' + group.channel.id + '/photo'" :alt="group.channel.name">
                                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                                    </div>
                                    <div class="signal-group-info">
                                        <div class="signal-group-title">
                                            [[ group.channel ? group.channel.name : (signalId === 'manual' ? 'Manual' : group.symbol || 'Signal') ]]
                                            <span class="symbol-badge" v-if="group.positions.length > 0">[[ group.positions[0].symbol ]]</span>
                                            <span class="count-badge">[[ group.positions.length ]]</span>
                                        </div>
                                        <div class="signal-group-meta">
                                            <span v-if="group.signal_time">[[ formatSignalTime(group.signal_time) ]]</span>
                                            <span v-else>[[ group.positions[0]?.direction || 'TRADE' ]]</span>
                                        </div>
                                    </div>
                                    <div class="signal-group-stats">
                                        <div class="signal-stat">
                                            <span class="signal-stat-label">Lots</span>
                                            <span class="signal-stat-value">[[ group.total_lots.toFixed(2) ]]</span>
                                        </div>
                                        <div class="signal-stat">
                                            <span class="signal-stat-label">P/L</span>
                                            <span class="signal-stat-value" :class="group.total_profit >= 0 ? 'profit-positive' : 'profit-negative'">
                                                [[ group.total_profit >= 0 ? '+' : '' ]]$[[ group.total_profit.toFixed(2) ]]
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="signal-group-body">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ticket</th>
                                                <th>Type</th>
                                                <th>Vol</th>
                                                <th>Entry</th>
                                                <th>Current</th>
                                                <th>P/L</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="pos in group.positions" :key="'grp-' + pos.position_ticket">
                                                <td class="font-mono" style="font-size: 11px;">[[ pos.position_ticket ]]</td>
                                                <td :class="pos.direction === 'BUY' ? 'direction-buy' : 'direction-sell'">[[ pos.direction ]]</td>
                                                <td>[[ pos.lot_size ]]</td>
                                                <td class="font-mono">[[ formatPrice(pos.entry_price, pos.symbol) ]]</td>
                                                <td class="font-mono">[[ formatPrice(pos.current_price, pos.symbol) ]]</td>
                                                <td :class="pos.profit >= 0 ? 'profit-positive' : 'profit-negative'" style="font-weight: 600;">
                                                    [[ pos.profit >= 0 ? '+' : '' ]]$[[ pos.profit.toFixed(2) ]]
                                                </td>
                                                <td>
                                                    <button class="btn-action btn-close-trade" @click.stop="closePosition(pos.position_ticket)" :disabled="loading.trades[pos.position_ticket]" title="Close">
                                                        <span v-if="loading.trades[pos.position_ticket]" class="spinner" style="width: 10px; height: 10px;"></span>
                                                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div class="empty-state" v-if="mt5Positions.length === 0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                            <div>No open positions</div>
                            <div style="font-size: 11px; margin-top: 4px;">Your MT5 positions will appear here</div>
                        </div>
                    </div>
                    </div><!-- End v-else wrapper -->
                </div>
            </div>
