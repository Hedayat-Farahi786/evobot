<!-- Trades/Positions Page View -->
                <div class="page-view" :class="{ active: activeNavItem === 'trades' }">
                    <div class="page-header">
                        <div>
                            <h1>Open Positions</h1>
                            <p>Manage your current MT5 trading positions</p>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;" v-if="status.bot_running">
                            <!-- View Toggle -->
                            <div class="view-toggle" v-if="mt5Positions.length > 0">
                                <button class="view-toggle-btn" :class="{ active: groupPositionsView }" @click="setPositionsView(true)" title="Group by Signal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
                                    Group
                                </button>
                                <button class="view-toggle-btn" :class="{ active: !groupPositionsView }" @click="setPositionsView(false)" title="List View">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
                                    List
                                </button>
                            </div>
                            <button class="btn" @click="refreshPositions" :disabled="loading.positions">
                                <span v-if="loading.positions" class="spinner spinner-dark"></span>
                                <svg v-else xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="settings-container" v-if="!status.bot_running">
                        <div class="bot-stopped-placeholder">
                            <div class="bot-stopped-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                            </div>
                            <div class="bot-stopped-title">No Active Positions</div>
                            <div class="bot-stopped-subtitle">The bot needs to be running to display open positions. Start the bot to begin monitoring and executing trades in real-time.</div>
                            <div class="bot-stopped-actions">
                                <button v-if="!account.login" class="btn-start" @click="showMT5LoginModal = true" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border);">
                                    <img src="/assets/logos/mt5.webp" alt="MT5" style="width: 18px; height: 18px; margin-right: 8px; border-radius: 3px;" />
                                    Connect MT5
                                </button>
                                <button v-else class="btn-start" @click="startBot" :disabled="loading.start || (!status.telegram_connected && !telegramSessionValid)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6 3 20 12 6 21 6 3"/></svg>
                                    Start Bot
                                </button>
                                <div class="bot-stopped-status" :class="{ ready: account.login && (telegramSessionValid || status.telegram_connected) }">
                                    <span class="status-dot"></span>
                                    <span v-if="!account.login">MT5 account required</span>
                                    <span v-else-if="(telegramSessionValid || status.telegram_connected)">Ready to start</span>
                                    <span v-else>Configure Telegram first</span>
                                </div>
                            </div>
                            <div class="bot-stopped-features">
                                <div class="bot-stopped-feature">
                                    <div class="bot-stopped-feature-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                                    </div>
                                    <span>Live P&L Tracking</span>
                                </div>
                                <div class="bot-stopped-feature">
                                    <div class="bot-stopped-feature-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                    </div>
                                    <span>Position Management</span>
                                </div>
                                <div class="bot-stopped-feature">
                                    <div class="bot-stopped-feature-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
                                    </div>
                                    <span>Group by Signal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-container" v-else>
                        <!-- Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-label">Open Positions</div>
                                <div class="stat-value">[[ mt5Positions.length ]]</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total P/L</div>
                                <div class="stat-value" :class="totalPnL >= 0 ? 'positive' : 'negative'">
                                    [[ totalPnL >= 0 ? '+' : '' ]][[ currencySymbol ]][[ totalPnL.toFixed(2) ]]
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Margin Used</div>
                                <div class="stat-value">[[ currencySymbol ]][[ formatNumber(account.margin) ]]</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Free Margin</div>
                                <div class="stat-value">[[ currencySymbol ]][[ formatNumber(account.free_margin) ]]</div>
                            </div>
                        </div>
                        
                        <!-- Grouped Positions by Signal -->
                        <div v-if="Object.keys(groupedPositions).length > 0 && groupPositionsView">
                            <div v-for="(group, signalId) in groupedPositions" :key="signalId" class="signal-group" :class="{ collapsed: group.collapsed }">
                                <div class="signal-group-header" @click="group.collapsed = !group.collapsed">
                                    <div class="signal-group-expand">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                                    </div>
                                    <div class="signal-channel-avatar">
                                        <img v-if="group.channel && group.channel.photo" :src="'/api/channels/' + group.channel.id + '/photo'" :alt="group.channel.name">
                                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                                    </div>
                                    <div class="signal-group-info">
                                        <div class="signal-group-title">
                                            [[ group.channel ? group.channel.name : (signalId === 'manual' ? 'Manual Trades' : 'Unknown Signal') ]]
                                            <span class="symbol-badge" v-if="group.positions.length > 0">[[ group.positions[0].symbol ]]</span>
                                        </div>
                                        <div class="signal-group-meta">
                                            <span v-if="group.signal_time">[[ formatSignalTime(group.signal_time) ]]</span>
                                            <span v-else>[[ group.positions.length ]] position[[ group.positions.length !== 1 ? 's' : '' ]]</span>
                                        </div>
                                    </div>
                                    <div class="signal-group-stats">
                                        <div class="signal-stat">
                                            <span class="signal-stat-label">Lots</span>
                                            <span class="signal-stat-value">[[ group.total_lots.toFixed(2) ]]</span>
                                        </div>
                                        <div class="signal-stat">
                                            <span class="signal-stat-label">P/L</span>
                                            <span class="signal-stat-value" :class="group.total_profit >= 0 ? 'profit-positive' : 'profit-negative'">
                                                [[ group.total_profit >= 0 ? '+' : '' ]][[ currencySymbol ]][[ group.total_profit.toFixed(2) ]]
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="signal-group-body">
                                    <table style="width: 100%;">
                                        <thead>
                                            <tr>
                                                <th>Ticket</th>
                                                <th>Type</th>
                                                <th>Volume</th>
                                                <th>Entry</th>
                                                <th>Current</th>
                                                <th>SL</th>
                                                <th>TP</th>
                                                <th>P/L</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="pos in group.positions" :key="'grp-' + pos.position_ticket">
                                                <td class="font-mono">[[ pos.position_ticket ]]</td>
                                                <td :class="pos.direction === 'BUY' ? 'direction-buy' : 'direction-sell'">[[ pos.direction ]]</td>
                                                <td>[[ pos.lot_size ]]</td>
                                                <td class="font-mono">[[ formatPrice(pos.entry_price, pos.symbol) ]]</td>
                                                <td class="font-mono">[[ formatPrice(pos.current_price, pos.symbol) ]]</td>
                                                <td class="font-mono">[[ pos.stop_loss ? formatPrice(pos.stop_loss, pos.symbol) : '-' ]]</td>
                                                <td class="font-mono">[[ pos.take_profit_1 ? formatPrice(pos.take_profit_1, pos.symbol) : '-' ]]</td>
                                                <td :class="pos.profit >= 0 ? 'profit-positive' : 'profit-negative'" style="font-weight: 600;">
                                                    [[ pos.profit >= 0 ? '+' : '' ]][[ currencySymbol ]][[ pos.profit.toFixed(2) ]]
                                                </td>
                                                <td>
                                                    <div class="trade-actions">
                                                        <button class="btn-action btn-modify" @click="openModifyModal(pos)" title="Modify SL/TP">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                                        </button>
                                                        <button class="btn-action btn-close-trade" @click="closePosition(pos.position_ticket)" :disabled="loading.trades[pos.position_ticket]" title="Close Position">
                                                            <span v-if="loading.trades[pos.position_ticket]" class="spinner" style="width: 10px; height: 10px;"></span>
                                                            <svg v-else xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- List View (Flat Table) -->
                        <div class="settings-card" v-if="mt5Positions.length > 0 && !groupPositionsView" style="max-width: 100%;">
                            <div class="settings-card-header">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                                <h3>All Positions</h3>
                            </div>
                            <div class="settings-card-body" style="padding: 0;">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Ticket</th>
                                            <th>Symbol</th>
                                            <th>Type</th>
                                            <th>Volume</th>
                                            <th>Entry</th>
                                            <th>Current</th>
                                            <th>SL</th>
                                            <th>TP</th>
                                            <th>P/L</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="pos in mt5Positions" :key="'list-' + pos.position_ticket">
                                            <td class="font-mono">[[ pos.position_ticket ]]</td>
                                            <td><span class="symbol-badge">[[ pos.symbol ]]</span></td>
                                            <td :class="pos.direction === 'BUY' ? 'direction-buy' : 'direction-sell'">[[ pos.direction ]]</td>
                                            <td>[[ pos.lot_size ]]</td>
                                            <td class="font-mono">[[ formatPrice(pos.entry_price, pos.symbol) ]]</td>
                                            <td class="font-mono">[[ formatPrice(pos.current_price, pos.symbol) ]]</td>
                                            <td class="font-mono">[[ pos.stop_loss ? formatPrice(pos.stop_loss, pos.symbol) : '-' ]]</td>
                                            <td class="font-mono">[[ pos.take_profit_1 ? formatPrice(pos.take_profit_1, pos.symbol) : '-' ]]</td>
                                            <td :class="pos.profit >= 0 ? 'profit-positive' : 'profit-negative'" style="font-weight: 600;">
                                                [[ pos.profit >= 0 ? '+' : '' ]][[ currencySymbol ]][[ pos.profit.toFixed(2) ]]
                                            </td>
                                            <td>
                                                <div class="trade-actions">
                                                    <button class="btn-action btn-modify" @click="openModifyModal(pos)" title="Modify SL/TP">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                                    </button>
                                                    <button class="btn-action btn-close-trade" @click="closePosition(pos.position_ticket)" :disabled="loading.trades[pos.position_ticket]" title="Close Position">
                                                        <span v-if="loading.trades[pos.position_ticket]" class="spinner" style="width: 10px; height: 10px;"></span>
                                                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Empty State Card -->
                        <div class="settings-card" v-if="mt5Positions.length === 0" style="max-width: 100%;">
                            <div class="settings-card-header">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                                <h3>Active Positions</h3>
                            </div>
                            <div class="settings-card-body" style="padding: 0;">
                                <div class="empty-state" style="padding: 60px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                                    <div style="margin-top: 16px; font-size: 14px;">No open positions</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Your MT5 positions will appear here when you have active trades</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
